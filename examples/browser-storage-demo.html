<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radio4000 SDK - Browser Storage Demo</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
    }
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #1976D2;
    }
    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    .channels-list {
      margin-top: 15px;
    }
    .channel-item {
      background: #f5f5f5;
      padding: 10px;
      margin: 5px 0;
      border-radius: 3px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .track-item {
      background: #e8f5e9;
      padding: 8px;
      margin: 3px 0;
      border-radius: 3px;
      font-size: 14px;
    }
    .tracks-section {
      margin-top: 10px;
      padding: 10px;
      background: #fafafa;
      border-radius: 3px;
    }
    .storage-data {
      background: #fafafa;
      padding: 10px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 3px;
      margin: 10px 0;
    }
    .success {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 10px;
      border-radius: 3px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>ðŸ“» Radio4000 SDK - Browser Storage Demo</h1>

  <div class="info">
    <strong>Local-First Mode</strong><br>
    This demo uses the browser storage adapter. All data is stored in localStorage.
    No internet connection or backend required!
  </div>

  <!-- Auth Section -->
  <div class="section">
    <h2>Authentication (Mock)</h2>
    <div id="auth-status">Not signed in</div>
    <div style="margin-top: 10px;">
      <input type="email" id="email" placeholder="Email" value="demo@radio4000.com">
      <input type="password" id="password" placeholder="Password" value="password">
      <button onclick="signIn()">Sign In</button>
      <button onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- Channels Section -->
  <div class="section">
    <h2>Channels</h2>
    <div>
      <input type="text" id="channel-name" placeholder="Channel Name" value="My Test Channel">
      <input type="text" id="channel-slug" placeholder="Slug" value="my-test-channel">
      <button onclick="createChannel()">Create Channel</button>
      <button onclick="loadChannels()">Load Channels</button>
      <button onclick="clearChannels()">Clear All</button>
    </div>
    <div class="channels-list" id="channels-list"></div>
  </div>

  <!-- Tracks Section -->
  <div class="section">
    <h2>Tracks</h2>
    <div>
      <select id="track-channel-id">
        <option value="">Select a channel first</option>
      </select>
      <br><br>
      <input type="text" id="track-url" placeholder="Track URL" value="https://www.youtube.com/watch?v=dQw4w9WgXcQ" style="width: 300px;">
      <input type="text" id="track-title" placeholder="Track Title" value="My Awesome Track">
      <button onclick="createTrack()">Create Track</button>
      <button onclick="loadTracks()">Load All Tracks</button>
      <button onclick="clearTracks()">Clear All</button>
    </div>
    <div class="tracks-section" id="tracks-list"></div>
  </div>

  <!-- localStorage Viewer -->
  <div class="section">
    <h2>localStorage Contents</h2>
    <button onclick="viewStorage()">Refresh View</button>
    <button onclick="clearStorage()">Clear All Storage</button>
    <div class="storage-data" id="storage-data"></div>
  </div>

  <!-- Messages -->
  <div id="messages"></div>

  <script type="module">
    // Import the SDK (adjust path for your setup)
    // In production: import {createSdk} from '@radio4000/sdk'

    // For this demo, we'll inline a minimal version
    import {BrowserStorageAdapter} from '../src/adapters/browser.js'

    // Create SDK with browser storage
    window.adapter = new BrowserStorageAdapter({
      prefix: 'radio4000-demo'
    })

    // Simple SDK-like interface for demo
    window.sdk = {
      channels: {
        createChannel: async ({name, slug}) => {
          const result = await adapter.from('channels')
            .insert({name, slug})
            .select()
            .single()
          return result
        },
        readChannels: async () => {
          return await adapter.from('channels').select('*')
        },
        deleteChannel: async (id) => {
          return await adapter.from('channels').delete().eq('id', id)
        }
      },
      tracks: {
        createTrack: async (channelId, {url, title, description}) => {
          const result = await adapter.from('tracks')
            .insert({url, title, description, channel_id: channelId})
            .select()
            .single()
          return result
        },
        readTracks: async () => {
          return await adapter.from('tracks').select('*')
        },
        deleteTrack: async (id) => {
          return await adapter.from('tracks').delete().eq('id', id)
        }
      },
      auth: adapter.auth
    }

    // Setup auth listener
    window.sdk.auth.onAuthStateChange((event, session) => {
      updateAuthStatus()
    })

    // Initialize
    window.addEventListener('load', () => {
      updateAuthStatus()
      viewStorage()
      loadChannels()
      loadTracks()
    })
  </script>

  <script>
    function showMessage(text, isError = false) {
      const div = document.createElement('div')
      div.className = isError ? 'error' : 'success'
      div.textContent = text
      document.getElementById('messages').appendChild(div)
      setTimeout(() => div.remove(), 3000)
    }

    async function updateAuthStatus() {
      const {data} = await window.sdk.auth.getSession()
      const status = document.getElementById('auth-status')

      if (data.session) {
        status.innerHTML = `<strong>Signed in as:</strong> ${data.session.user.email}`
        status.style.color = 'green'
      } else {
        status.innerHTML = 'Not signed in'
        status.style.color = '#666'
      }
    }

    async function signIn() {
      const email = document.getElementById('email').value
      const password = document.getElementById('password').value

      const {data, error} = await window.sdk.auth.signInWithPassword({email, password})

      if (error) {
        showMessage('Sign in failed: ' + error.message, true)
      } else {
        showMessage('Signed in successfully!')
        viewStorage()
      }
    }

    async function signOut() {
      await window.sdk.auth.signOut()
      showMessage('Signed out')
      viewStorage()
    }

    async function createChannel() {
      const name = document.getElementById('channel-name').value
      const slug = document.getElementById('channel-slug').value

      if (!name || !slug) {
        showMessage('Please enter channel name and slug', true)
        return
      }

      const {data, error} = await window.sdk.channels.createChannel({name, slug})

      if (error) {
        showMessage('Error: ' + error.message, true)
      } else {
        showMessage(`Channel "${name}" created!`)
        loadChannels()
        viewStorage()
      }
    }

    async function loadChannels() {
      const {data, error} = await window.sdk.channels.readChannels()
      const list = document.getElementById('channels-list')
      const select = document.getElementById('track-channel-id')

      if (error) {
        list.innerHTML = `<div class="error">${error.message}</div>`
        return
      }

      if (!data || data.length === 0) {
        list.innerHTML = '<em>No channels yet. Create one!</em>'
        select.innerHTML = '<option value="">Create a channel first</option>'
        return
      }

      // Update channel list
      list.innerHTML = data.map(channel => `
        <div class="channel-item">
          <div>
            <strong>${channel.name}</strong><br>
            <small>Slug: ${channel.slug} | Created: ${new Date(channel.created_at).toLocaleString()}</small>
          </div>
          <button onclick="deleteChannel('${channel.id}')">Delete</button>
        </div>
      `).join('')

      // Update channel select for tracks
      select.innerHTML = '<option value="">Select a channel</option>' +
        data.map(channel => `<option value="${channel.id}">${channel.name}</option>`).join('')
    }

    async function deleteChannel(id) {
      if (!confirm('Delete this channel?')) return

      await window.sdk.channels.deleteChannel(id)
      showMessage('Channel deleted')
      loadChannels()
      viewStorage()
    }

    async function clearChannels() {
      if (!confirm('Delete all channels?')) return

      const {data} = await window.sdk.channels.readChannels()
      for (const channel of data || []) {
        await window.sdk.channels.deleteChannel(channel.id)
      }

      showMessage('All channels cleared')
      loadChannels()
      viewStorage()
    }

    function viewStorage() {
      const storage = document.getElementById('storage-data')
      const items = []

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i)
        if (key.startsWith('radio4000-demo:')) {
          const value = localStorage.getItem(key)
          items.push(`<strong>${key}</strong>:\n${value}\n`)
        }
      }

      if (items.length === 0) {
        storage.innerHTML = '<em>No data in localStorage yet</em>'
      } else {
        storage.innerHTML = items.join('\n')
      }
    }

    function clearStorage() {
      if (!confirm('Clear ALL localStorage data?')) return

      const keys = []
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i)
        if (key.startsWith('radio4000-demo:')) {
          keys.push(key)
        }
      }

      keys.forEach(key => localStorage.removeItem(key))

      showMessage('Storage cleared')
      loadChannels()
      loadTracks()
      viewStorage()
      updateAuthStatus()
    }

    // Track functions
    async function createTrack() {
      const channelId = document.getElementById('track-channel-id').value
      const url = document.getElementById('track-url').value
      const title = document.getElementById('track-title').value

      if (!channelId) {
        showMessage('Please select a channel first', true)
        return
      }

      if (!url || !title) {
        showMessage('Please enter track URL and title', true)
        return
      }

      const {data, error} = await window.sdk.tracks.createTrack(channelId, {url, title})

      if (error) {
        showMessage('Error: ' + error.message, true)
      } else {
        showMessage(`Track "${title}" created!`)
        loadTracks()
        viewStorage()
      }
    }

    async function loadTracks() {
      const {data, error} = await window.sdk.tracks.readTracks()
      const list = document.getElementById('tracks-list')

      if (error) {
        list.innerHTML = `<div class="error">${error.message}</div>`
        return
      }

      if (!data || data.length === 0) {
        list.innerHTML = '<em>No tracks yet. Create one!</em>'
        return
      }

      list.innerHTML = '<h3>All Tracks (' + data.length + ')</h3>' +
        data.map(track => `
          <div class="track-item">
            <strong>${track.title}</strong><br>
            <small>URL: ${track.url}</small><br>
            <small>Channel ID: ${track.channel_id || 'N/A'} | Created: ${new Date(track.created_at).toLocaleString()}</small>
            <button onclick="deleteTrack('${track.id}')" style="margin-left: 10px; padding: 3px 8px; font-size: 12px;">Delete</button>
          </div>
        `).join('')
    }

    async function deleteTrack(id) {
      if (!confirm('Delete this track?')) return

      await window.sdk.tracks.deleteTrack(id)
      showMessage('Track deleted')
      loadTracks()
      viewStorage()
    }

    async function clearTracks() {
      if (!confirm('Delete all tracks?')) return

      const {data} = await window.sdk.tracks.readTracks()
      for (const track of data || []) {
        await window.sdk.tracks.deleteTrack(track.id)
      }

      showMessage('All tracks cleared')
      loadTracks()
      viewStorage()
    }
  </script>
</body>
</html>
